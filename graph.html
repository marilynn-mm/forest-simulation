<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Node Adder Debug</title>

  <!-- Basic styling to show the canvas and change cursor -->
  <style>
    canvas {
      border: 1px solid black;     /* Gives the canvas a visible border */
      cursor: crosshair;           /* Makes the cursor a cross when hovering */
    }
  </style>
</head>
<body>

  <!-- Canvas element where we draw the graph -->
  <canvas id="graphCanvas" width="800" height="600"></canvas>

  <script>
    // Get canvas and its 2D drawing context
    const canvas = document.getElementById("graphCanvas");
    const ctx = canvas.getContext("2d");

    // Store the list of node positions
    let nodes = [];
    let edges = [];

    // Radius of each node circle
    const radius = 10;

    // Dragging nodes
    let isDragging = false;
    let dragStartIndex = null;
    let currentMouse = { x: 0, y: 0 };
    let movedDuringDrag = false;
    let suppressClick = false;


    // Get mouse position relative to canvas
    function getMousePos(e) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    }

    // Find index of node near (x, y)
    function findNodeAt(x, y) {
      return nodes.findIndex(node =>
        Math.hypot(node.x - x, node.y - y) < radius
      );
    }

    // Mouse down: try to start a drag from a node
    canvas.addEventListener("mousedown", (e) => {
      const { x, y } = getMousePos(e);
      const nodeIndex = findNodeAt(x, y);
      if (nodeIndex !== -1) {
        isDragging = true;
        dragStartIndex = nodeIndex;
        currentMouse = { x, y };
        movedDuringDrag = false;
      }
    });

    // Mouse move: update temporary line if dragging
    canvas.addEventListener("mousemove", (e) => {
      if (isDragging) {
        movedDuringDrag = true;
        currentMouse = getMousePos(e);
        draw();
      }
    });

    // Mouse up: if ended on a different node, add edge
    canvas.addEventListener("mouseup", (e) => {
      if (isDragging) {
        const { x, y } = getMousePos(e);
        const endIndex = findNodeAt(x, y);
        if (endIndex !== -1 && endIndex !== dragStartIndex) {
          edges.push([dragStartIndex, endIndex]);
          console.log(`Edge created: ${dragStartIndex} → ${endIndex}`);
        }
        isDragging = false;
        dragStartIndex = null;
        movedDuringDrag = false;
        suppressClick = true;
        draw();
      }
    });

    // Event listener for mouse clicks on the canvas
    canvas.addEventListener("click", (e) => {
      // Get mouse position relative to canvas
      const rect = canvas.getBoundingClientRect(); // canvas position in page
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if (suppressClick) {
        suppressClick = false; // reset for future clicks
        return; // ✅ skip click after drag
    }

      // Add new node at click location
      nodes.push({ x, y });

      // Log coordinates to console for debugging
      console.log(`Added node at: (${x.toFixed(1)}, ${y.toFixed(1)})`);

      // Redraw all nodes
      draw();
    });


    // Draw everything
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw edges
      edges.forEach(([i, j]) => {
        const a = nodes[i];
        const b = nodes[j];
        ctx.beginPath();
        ctx.moveTo(a.x, a.y);
        ctx.lineTo(b.x, b.y);
        ctx.stroke();
      });

      // Draw drag line
      if (isDragging && dragStartIndex !== null) {
        const start = nodes[dragStartIndex];
        ctx.beginPath();
        ctx.moveTo(start.x, start.y);
        ctx.lineTo(currentMouse.x, currentMouse.y);
        ctx.setLineDash([5, 5]);
        ctx.stroke();
        ctx.setLineDash([]);
      }

      // Draw nodes
      nodes.forEach((node) => {
        ctx.beginPath();
        ctx.arc(node.x, node.y, radius, 0, 2 * Math.PI);
        ctx.fillStyle = "skyblue";
        ctx.fill();
        ctx.stroke();
      });
    }

    draw();
  </script>
</body>
</html>
